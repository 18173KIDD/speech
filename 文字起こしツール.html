<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éŸ³å£°æ–‡å­—èµ·ã“ã—ãƒ„ãƒ¼ãƒ«</title>
    <style>
        :root {
            --primary-color: #4a6fa5;
            --primary-dark: #3a5a8c;
            --secondary-color: #6c757d;
            --light-color: #f8f9fa;
            --dark-color: #343a40;
            --success-color: #28a745;
            --info-color: #17a2b8;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.6;
            color: var(--dark-color);
            background-color: #f5f7fa;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 30px;
            position: relative;
        }

        h1, h2, h3 {
            color: var(--primary-color);
            margin-bottom: 20px;
        }

        h1 {
            text-align: center;
            border-bottom: 2px solid var(--light-color);
            padding-bottom: 15px;
            margin-bottom: 25px;
        }

        .upload-section, .prompt-section, .result-section, .processing-section {
            margin-bottom: 30px;
        }

        .drop-area {
            border: 3px dashed #ccc;
            border-radius: 8px;
            padding: 25px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 15px;
        }

        .drop-area:hover {
            border-color: var(--primary-color);
            background-color: var(--light-color);
        }

        .drop-area.active {
            border-color: var(--success-color);
            background-color: rgba(40, 167, 69, 0.1);
        }

        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.3s ease;
        }

        button:hover {
            background-color: var(--primary-dark);
        }

        button:disabled {
            background-color: var(--secondary-color);
            cursor: not-allowed;
        }

        #transcribeBtn {
            width: 100%;
            padding: 12px;
            font-weight: bold;
            font-size: 1.1rem;
            margin-top: 15px;
        }

        .file-info {
            background-color: var(--light-color);
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
            display: none;
        }

        textarea {
            width: 100%;
            padding: 15px;
            border: 1px solid #ccc;
            border-radius: 4px;
            resize: vertical;
            font-family: inherit;
            font-size: 0.95rem;
            line-height: 1.5;
            min-height: 200px;
            white-space: pre-wrap;
        }

        #promptInput {
            background-color: #f8f9fa;
            border-color: #e9ecef;
        }

        .progress {
            height: 20px;
            background-color: #e9ecef;
            border-radius: 10px;
            margin: 20px 0;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            width: 0;
            background-color: var(--primary-color);
            transition: width 0.3s ease;
        }

        .tabs {
            display: flex;
            margin-bottom: 15px;
            border-bottom: 1px solid #ddd;
        }

        .tab-btn {
            padding: 10px 15px;
            background-color: transparent;
            color: var(--dark-color);
            border: none;
            border-bottom: 3px solid transparent;
            margin-right: 5px;
        }

        .tab-btn.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }

        .tab-pane {
            display: none;
            margin-bottom: 20px;
        }

        .tab-pane.active {
            display: block;
        }

        .result-text {
            background-color: var(--light-color);
            padding: 15px;
            border-radius: 4px;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            margin-bottom: 15px;
        }

        .action-buttons {
            display: flex;
            justify-content: space-between;
        }

        .action-buttons button {
            flex: 1;
            margin: 0 5px;
        }

        .copy-btn {
            padding: 3px 10px;
            font-size: 0.8rem;
            margin-left: 10px;
            background-color: var(--secondary-color);
        }

        .copy-btn:hover {
            background-color: var(--dark-color);
        }

        /* è¨­å®šã‚¢ã‚¤ã‚³ãƒ³ - ã‚ˆã‚Šç›®ç«‹ãŸãªãã—ãŸ */
        .settings-icon {
            position: fixed;
            bottom: 10px;
            left: 10px;
            width: 30px;
            height: 30px;
            background-color: var(--light-color);
            border: 1px solid #eee;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 1000;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            font-size: 0.9rem;
            opacity: 0.7;
            transition: opacity 0.3s ease;
        }
        
        .settings-icon:hover {
            opacity: 1;
        }

        /* è¨­å®šãƒ‘ãƒãƒ« */
        .settings-panel {
            position: fixed;
            bottom: 50px;
            left: 10px;
            width: 350px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            display: none;
            flex-direction: column;
            overflow: hidden;
        }

        .settings-header {
            background-color: var(--primary-color);
            color: white;
            padding: 10px 15px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .settings-content {
            padding: 15px;
            overflow-y: auto;
            max-height: 500px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            font-size: 0.9rem;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: inherit;
            font-size: 0.9rem;
        }

        .settings-footer {
            padding: 10px 15px;
            border-top: 1px solid #ddd;
            display: flex;
            justify-content: flex-end;
        }

        .api-key-display {
            font-family: monospace;
            background-color: #f8f9fa;
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 0.85rem;
            overflow: hidden;
            text-overflow: ellipsis;
            user-select: all;
            cursor: pointer;
            margin-top: 3px;
            border: 1px solid #e9ecef;
        }

        .api-instructions {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
            font-size: 0.9rem;
        }

        .api-instructions ol {
            margin-bottom: 0;
        }

        .api-instructions li {
            margin-bottom: 8px;
        }

        .api-instructions li:last-child {
            margin-bottom: 0;
        }

        .toggle-instructions {
            color: var(--primary-color);
            text-decoration: none;
            cursor: pointer;
        }

        .toggle-instructions:hover {
            text-decoration: underline;
        }

        .api-notification {
            background-color: #fff3cd;
            border: 1px solid #ffeeba;
            color: #856404;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
            font-size: 0.9rem;
            display: none;
        }

        /* ã‚¨ãƒ©ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³ */
        .error-icon {
            position: fixed;
            bottom: 10px;
            right: 10px;
            width: 40px;
            height: 40px;
            background-color: var(--light-color);
            border: 1px solid #ddd;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 1000;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .error-icon.has-errors {
            background-color: var(--danger-color);
            color: white;
        }

        /* ã‚¨ãƒ©ãƒ¼ã‚³ãƒ³ã‚½ãƒ¼ãƒ« */
        .error-console {
            position: fixed;
            bottom: 60px;
            right: 10px;
            width: 300px;
            z-index: 1000;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            display: none;
            flex-direction: column;
            overflow: hidden;
        }

        .error-header {
            background-color: var(--danger-color);
            color: white;
            padding: 8px 10px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .error-content {
            overflow-y: auto;
            max-height: 250px;
            padding: 10px;
        }

        .error-message {
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid #f5c6cb;
            font-size: 0.9rem;
        }

        .error-message:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }

        .error-footer {
            padding: 5px 10px;
            border-top: 1px solid #ddd;
        }

        .clear-btn {
            background-color: var(--secondary-color);
            color: white;
            border: none;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 0.8rem;
            cursor: pointer;
            float: right;
        }

        /* å†å®Ÿè¡Œæ™‚ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        @keyframes pulse {
            0% { opacity: 0.6; }
            50% { opacity: 1; }
            100% { opacity: 0.6; }
        }

        .processing-text {
            display: inline-block;
            animation: pulse 1.5s infinite;
            margin-left: 10px;
            font-size: 0.9rem;
            color: var(--primary-color);
        }

        .loader {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(74, 111, 165, 0.3);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s ease-in-out infinite;
            margin-right: 8px;
            vertical-align: middle;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* æ™‚é–“è¡¨ç¤ºç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
        .time-info {
            font-size: 0.9rem;
            color: var(--secondary-color);
            margin-top: 5px;
        }

        /* è©±è€…ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .speaker-tag {
            font-weight: bold;
            padding: 2px 5px;
            border-radius: 3px;
            margin-right: 5px;
            background-color: #e3f2fd;
            color: #0d47a1;
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .action-buttons button {
                margin: 5px 0;
            }

            .error-console, .settings-panel {
                width: 85%;
                left: 7.5%;
                right: 7.5%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>éŸ³å£°æ–‡å­—èµ·ã“ã—ãƒ„ãƒ¼ãƒ«</h1>
        
        <div id="apiNotification" class="api-notification">
            <strong>APIã‚­ãƒ¼ãŒå¿…è¦ã§ã™</strong>: ã“ã®ãƒ„ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã™ã‚‹ã«ã¯ã€ElevenLabsã¨Gemini APIã‚­ãƒ¼ã‚’è¨­å®šãƒ‘ãƒãƒ«ã§è¨­å®šã—ã¦ãã ã•ã„ã€‚
            <a href="#" id="showSettingsBtn">è¨­å®šã‚’é–‹ã</a>
        </div>
        
        <div class="upload-section">
            <div class="drop-area" id="dropArea">
                <p>ã“ã“ã«éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ­ãƒƒãƒ—ã™ã‚‹ã‹ã€ã‚¯ãƒªãƒƒã‚¯ã—ã¦é¸æŠã—ã¦ãã ã•ã„</p>
                <input type="file" id="fileInput" accept="audio/*" hidden>
            </div>
            <div class="file-info" id="fileInfo"></div>
            <button id="transcribeBtn" disabled>æ–‡å­—èµ·ã“ã—é–‹å§‹</button>
        </div>

        <div class="processing-section" id="processingSection" style="display: none;">
            <div class="progress">
                <div class="progress-bar" id="progressBar"></div>
            </div>
            <p id="statusText">å‡¦ç†ä¸­...</p>
            <p id="timeInfo" class="time-info"></p>
        </div>

        <div class="prompt-section">
            <h3>å‡ºåŠ›å½¢å¼ã®è¨­å®šï¼ˆæ–‡å­—èµ·ã“ã—ã®æ•´ç†æ–¹æ³•ï¼‰</h3>
            <textarea id="promptInput" rows="6" placeholder="æ–‡å­—èµ·ã“ã—ãƒ‡ãƒ¼ã‚¿ã‚’ä»¥ä¸‹ã®å½¢å¼ã§æ•´ç†ã—ã¦ãã ã•ã„">ã€å‡ºåŠ›å½¢å¼ã®ãƒ«ãƒ¼ãƒ«ã€‘
1. å¤§ããªã‚¿ã‚¤ãƒˆãƒ« â†’ ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒˆãƒ« â†’ ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã”ã¨ã®300æ–‡å­—ç¨‹åº¦ã®èª¬æ˜ â†’ å®Ÿéš›ã®ä¼šè©±æ–‡
2. ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¯ä¼šè©±ã®æµã‚Œã‚„è©±é¡Œã«æ²¿ã£ã¦ã€éåº¦ã«ç´°ã‹ãåˆ†ã‘ãšã€é©åˆ‡ãªç²’åº¦ã§åŒºåˆ‡ã‚‹
3. èª¬æ˜æ–‡ã¯è©±é¡Œã®ãƒã‚¤ãƒ³ãƒˆã‚’è¦ç´„ã—ã€å†…å®¹ç†è§£ãŒã—ã‚„ã™ã„ã‚ˆã†ã«ã™ã‚‹
4. å®Ÿéš›ã®ä¼šè©±æ–‡ã¯ç™ºè©±é †ã«ä¸¦ã¹ã€å…ƒã®ãƒªã‚ºãƒ ã‚„é›°å›²æ°—ã‚’æ®‹ã™ã€‚ãŸã ã—ã€ã€Œãˆãƒ¼ã€ã€Œã‚ãƒ¼ã€ãªã©ã®ä¸è¦ãªé–“æŠ•è©ã¯å‰Šé™¤ã™ã‚‹ã€‚ç™ºè©±å†…å®¹ã®æ„è¨³ãƒ»ç·¨é›†ã¯è¡Œã‚ãªã„ã€‚
5. å…¨ä½“ã‚’é€šã—ã¦èª­ã¿æ‰‹ãŒæµã‚Œã‚’ç†è§£ã—ã‚„ã™ã„ã‚ˆã†ã«æ•´ãˆã‚‹</textarea>
        </div>

        <div class="result-section" id="resultSection" style="display: none;">
            <div class="tabs">
                <button class="tab-btn active" data-target="rawTab">ç”Ÿã®æ–‡å­—èµ·ã“ã—</button>
                <button class="tab-btn" data-target="organizedTab">æ•´ç†æ¸ˆã¿ãƒ†ã‚­ã‚¹ãƒˆ</button>
            </div>
            
            <div class="tab-content">
                <div id="rawTab" class="tab-pane active">
                    <h3>æ–‡å­—èµ·ã“ã—çµæœ <button id="copyRawBtn" class="copy-btn">ã‚³ãƒ”ãƒ¼</button></h3>
                    <div id="rawTranscription" class="result-text"></div>
                </div>
                
                <div id="organizedTab" class="tab-pane">
                    <h3>æ•´ç†æ¸ˆã¿ãƒ†ã‚­ã‚¹ãƒˆ <button id="copyOrganizedBtn" class="copy-btn">ã‚³ãƒ”ãƒ¼</button></h3>
                    <div id="organizedText" class="result-text"></div>
                </div>
            </div>
            
            <div class="action-buttons">
                <button id="saveRawBtn">ç”Ÿãƒ†ã‚­ã‚¹ãƒˆã‚’ä¿å­˜</button>
                <button id="saveOrganizedBtn">æ•´ç†æ¸ˆã¿ãƒ†ã‚­ã‚¹ãƒˆã‚’ä¿å­˜</button>
                <button id="reorganizeBtn">è¦ç´„ã‚’å†å®Ÿè¡Œ</button>
                <span id="reorganizeSpinner" style="display: none;"><span class="loader"></span><span class="processing-text">è¦ç´„å‡¦ç†ä¸­...</span></span>
            </div>
        </div>
    </div>

    <!-- è¨­å®šã‚¢ã‚¤ã‚³ãƒ³ - ã‚ˆã‚Šæ§ãˆã‚ãªãƒ‡ã‚¶ã‚¤ãƒ³ -->
    <div class="settings-icon" id="settingsIcon">âš™ï¸</div>

    <!-- è¨­å®šãƒ‘ãƒãƒ« -->
    <div class="settings-panel" id="settingsPanel">
        <div class="settings-header">
            <span>APIè¨­å®š</span>
            <span class="close-btn" id="closeSettingsBtn">Ã—</span>
        </div>
        <div class="settings-content">
            <div class="form-group">
                <label for="elevenLabsApiKey">ElevenLabs APIã‚­ãƒ¼ <a href="#" class="toggle-instructions" data-target="elevenLabsInstructions">(å–å¾—æ–¹æ³•)</a></label>
                <div class="api-instructions" id="elevenLabsInstructions" style="display: none;">
                    <ol style="margin: 10px 0; padding-left: 20px;">
                        <li>ä»¥ä¸‹ã®ãƒªãƒ³ã‚¯ã«ã‚¢ã‚¯ã‚»ã‚¹ï¼š<br><a href="https://elevenlabs.io/app/settings/api-keys" target="_blank">https://elevenlabs.io/app/settings/api-keys</a></li>
                        <li>ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’æŒã£ã¦ã„ãªã„å ´åˆã¯æ–°è¦ç™»éŒ²</li>
                        <li>ãƒ­ã‚°ã‚¤ãƒ³å¾Œã€APIã‚­ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</li>
                        <li>ã€ŒCreate New Keyã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦æ–°ã—ã„ã‚­ãƒ¼ã‚’ç”Ÿæˆ</li>
                        <li>ç”Ÿæˆã•ã‚ŒãŸã‚­ãƒ¼ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ã“ã¡ã‚‰ã«å…¥åŠ›</li>
                    </ol>
                    <p style="margin: 10px 0; color: #666;">â€» ç„¡æ–™ãƒ—ãƒ©ãƒ³ã§ã¯æœˆã«ç´„1æ™‚é–“åˆ†ã®æ–‡å­—èµ·ã“ã—ãŒå¯èƒ½ã§ã™</p>
                </div>
                <input type="password" id="elevenLabsApiKey" placeholder="ElevenLabs APIã‚­ãƒ¼ã‚’å…¥åŠ›">
                <div class="api-key-display" id="elevenLabsKeyDisplay">APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“</div>
            </div>
            <div class="form-group">
                <label for="geminiApiKey">Gemini APIã‚­ãƒ¼ <a href="#" class="toggle-instructions" data-target="geminiInstructions">(å–å¾—æ–¹æ³•)</a></label>
                <div class="api-instructions" id="geminiInstructions" style="display: none;">
                    <ol style="margin: 10px 0; padding-left: 20px;">
                        <li>ä»¥ä¸‹ã®ãƒªãƒ³ã‚¯ã«ã‚¢ã‚¯ã‚»ã‚¹ï¼š<br><a href="https://aistudio.google.com/app/apikey" target="_blank">https://aistudio.google.com/app/apikey</a></li>
                        <li>Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³</li>
                        <li>ã€ŒAPIã‚­ãƒ¼ã‚’å–å¾—ã€ã‚’ã‚¯ãƒªãƒƒã‚¯</li>
                        <li>æ–°ã—ã„APIã‚­ãƒ¼ãŒç”Ÿæˆã•ã‚Œã¾ã™</li>
                        <li>ç”Ÿæˆã•ã‚ŒãŸã‚­ãƒ¼ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ã“ã¡ã‚‰ã«å…¥åŠ›</li>
                    </ol>
                    <p style="margin: 10px 0; color: #666;">â€» ç„¡æ–™æ ã§ã¯1æ—¥1,500ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¾ã§ä½¿ç”¨å¯èƒ½ã§ã™</p>
                </div>
                <input type="password" id="geminiApiKey" placeholder="Gemini APIã‚­ãƒ¼ã‚’å…¥åŠ›">
                <div class="api-key-display" id="geminiKeyDisplay">APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“</div>
            </div>
            <div class="form-group">
                <label for="geminiModel">Geminiãƒ¢ãƒ‡ãƒ«</label>
                <select id="geminiModel">
                    <option value="gemini-2.0-flash">Gemini 2.0 Flash (æ¨å¥¨)</option>
                    <option value="gemini-2.0-flash-thinking">Gemini 2.0 Flash Thinking</option>
                    <option value="gemini-2.0-flash-lite">Gemini 2.0 Flash-Lite (ä½ã‚³ã‚¹ãƒˆ)</option>
                    <option value="gemini-2.0-pro">Gemini 2.0 Pro (é«˜æ€§èƒ½)</option>
                    <option value="gemini-1.5-flash">Gemini 1.5 Flash (æ—§ãƒãƒ¼ã‚¸ãƒ§ãƒ³)</option>
                    <option value="gemini-1.5-pro">Gemini 1.5 Pro (æ—§ãƒãƒ¼ã‚¸ãƒ§ãƒ³)</option>
                </select>
            </div>
        </div>
        <div class="settings-footer">
            <button id="saveSettingsBtn">ä¿å­˜</button>
        </div>
    </div>

    <!-- ã‚¨ãƒ©ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³ -->
    <div class="error-icon" id="errorIcon">ğŸ”</div>

    <!-- ã‚¨ãƒ©ãƒ¼ã‚³ãƒ³ã‚½ãƒ¼ãƒ« -->
    <div class="error-console" id="errorConsole">
        <div class="error-header">
            <span>ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°</span>
            <span class="close-btn" id="closeErrorBtn">Ã—</span>
        </div>
        <div class="error-content" id="errorContent">
            <div id="errorMessages"></div>
        </div>
        <div class="error-footer">
            <button class="clear-btn" id="clearErrorsBtn">ã‚¯ãƒªã‚¢</button>
        </div>
    </div>

    <script>
        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®Geminiãƒ¢ãƒ‡ãƒ«è¨­å®š
        const DEFAULT_GEMINI_MODEL = 'gemini-2.0-flash';
        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®APIã‚­ãƒ¼ã¯ç©ºæ–‡å­—åˆ—
        const DEFAULT_ELEVENLABS_API_KEY = '';
        const DEFAULT_GEMINI_API_KEY = '';

        // è¨­å®šã®å–å¾—
        let ELEVENLABS_API_KEY = localStorage.getItem('elevenLabsApiKey') || '';
        let GEMINI_API_KEY = localStorage.getItem('geminiApiKey') || '';
        let GEMINI_MODEL = localStorage.getItem('geminiModel') || DEFAULT_GEMINI_MODEL;

        document.addEventListener('DOMContentLoaded', () => {
            // è¦ç´ ã®å–å¾—
            const dropArea = document.getElementById('dropArea');
            const fileInput = document.getElementById('fileInput');
            const fileInfo = document.getElementById('fileInfo');
            const transcribeBtn = document.getElementById('transcribeBtn');
            const processingSection = document.getElementById('processingSection');
            const progressBar = document.getElementById('progressBar');
            const statusText = document.getElementById('statusText');
            const timeInfo = document.getElementById('timeInfo');
            const resultSection = document.getElementById('resultSection');
            const rawTranscription = document.getElementById('rawTranscription');
            const organizedText = document.getElementById('organizedText');
            const promptInput = document.getElementById('promptInput');
            const tabButtons = document.querySelectorAll('.tab-btn');
            const tabPanes = document.querySelectorAll('.tab-pane');
            const copyRawBtn = document.getElementById('copyRawBtn');
            const copyOrganizedBtn = document.getElementById('copyOrganizedBtn');
            const saveRawBtn = document.getElementById('saveRawBtn');
            const saveOrganizedBtn = document.getElementById('saveOrganizedBtn');
            const reorganizeBtn = document.getElementById('reorganizeBtn');
            const reorganizeSpinner = document.getElementById('reorganizeSpinner');
            
            // è¨­å®šé–¢é€£ã®è¦ç´ 
            const settingsIcon = document.getElementById('settingsIcon');
            const settingsPanel = document.getElementById('settingsPanel');

            // å–å¾—æ–¹æ³•ã®ãƒˆã‚°ãƒ«æ©Ÿèƒ½
            document.querySelectorAll('.toggle-instructions').forEach(toggle => {
                toggle.addEventListener('click', (e) => {
                    e.preventDefault();
                    const targetId = toggle.getAttribute('data-target');
                    const instructions = document.getElementById(targetId);
                    if (instructions.style.display === 'none') {
                        instructions.style.display = 'block';
                    } else {
                        instructions.style.display = 'none';
                    }
                });
            });
            const closeSettingsBtn = document.getElementById('closeSettingsBtn');
            const elevenLabsApiKeyInput = document.getElementById('elevenLabsApiKey');
            const geminiApiKeyInput = document.getElementById('geminiApiKey');
            const geminiModelSelect = document.getElementById('geminiModel');
            const saveSettingsBtn = document.getElementById('saveSettingsBtn');
            const elevenLabsKeyDisplay = document.getElementById('elevenLabsKeyDisplay');
            const geminiKeyDisplay = document.getElementById('geminiKeyDisplay');
            const apiNotification = document.getElementById('apiNotification');
            const showSettingsBtn = document.getElementById('showSettingsBtn');
            
            // ã‚¨ãƒ©ãƒ¼é–¢é€£ã®è¦ç´ 
            const errorIcon = document.getElementById('errorIcon');
            const errorConsole = document.getElementById('errorConsole');
            const closeErrorBtn = document.getElementById('closeErrorBtn');
            const errorMessages = document.getElementById('errorMessages');
            const clearErrorsBtn = document.getElementById('clearErrorsBtn');

            // è¨­å®šãƒ‘ãƒãƒ«ã«ç¾åœ¨ã®å€¤ã‚’è¨­å®š
            elevenLabsApiKeyInput.value = '';
            geminiApiKeyInput.value = '';
            geminiModelSelect.value = GEMINI_MODEL;
            elevenLabsKeyDisplay.textContent = `ç¾åœ¨è¨­å®šã•ã‚Œã¦ã„ã‚‹APIã‚­ãƒ¼: ${maskApiKey(ELEVENLABS_API_KEY)}`;
            geminiKeyDisplay.textContent = `ç¾åœ¨è¨­å®šã•ã‚Œã¦ã„ã‚‹APIã‚­ãƒ¼: ${maskApiKey(GEMINI_API_KEY)}`;

            // APIã‚­ãƒ¼ãŒæœªè¨­å®šãªã‚‰ã°é€šçŸ¥ã‚’è¡¨ç¤º
            if (!ELEVENLABS_API_KEY || !GEMINI_API_KEY) {
                apiNotification.style.display = 'block';
            }

            // é€šçŸ¥ã®è¨­å®šãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã¨ã
            showSettingsBtn.addEventListener('click', (e) => {
                e.preventDefault();
                settingsPanel.style.display = 'flex';
            });

            // APIã‚­ãƒ¼è¡¨ç¤ºã®ãƒã‚¹ã‚¯
            function maskApiKey(key) {
                if (!key) return 'ãªã—';
                if (key === DEFAULT_ELEVENLABS_API_KEY || key === DEFAULT_GEMINI_API_KEY) {
                    return '(ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ»å¤‰æ›´æ¨å¥¨)';
                }
                // æœ€åˆã®8æ–‡å­—ã¨æœ€å¾Œã®4æ–‡å­—ã‚’æ®‹ã—ã¦ãƒã‚¹ã‚¯
                return key.substring(0, 8) + '...' + key.substring(key.length - 4);
            }

            // é¸æŠã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«
            let selectedFile = null;
            let transcriptionResult = null;
            let rawTranscriptionText = '';
            let errorCount = 0;
            let audioFileDuration = 0; // éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã®é•·ã•ï¼ˆç§’ï¼‰

            // è¨­å®šãƒ‘ãƒãƒ«é–¢é€£
            settingsIcon.addEventListener('click', () => {
                settingsPanel.style.display = settingsPanel.style.display === 'flex' ? 'none' : 'flex';
            });

            closeSettingsBtn.addEventListener('click', () => {
                settingsPanel.style.display = 'none';
            });

            saveSettingsBtn.addEventListener('click', () => {
                // APIã‚­ãƒ¼ãŒå…¥åŠ›ã•ã‚Œã¦ã„ãŸã‚‰ä¿å­˜ã€ç©ºãªã‚‰å‰Šé™¤ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’ä½¿ç”¨ã™ã‚‹ï¼‰
                if (elevenLabsApiKeyInput.value.trim()) {
                    localStorage.setItem('elevenLabsApiKey', elevenLabsApiKeyInput.value.trim());
                    ELEVENLABS_API_KEY = elevenLabsApiKeyInput.value.trim();
                    elevenLabsKeyDisplay.textContent = `ç¾åœ¨è¨­å®šã•ã‚Œã¦ã„ã‚‹APIã‚­ãƒ¼: ${maskApiKey(ELEVENLABS_API_KEY)}`;
                }

                if (geminiApiKeyInput.value.trim()) {
                    localStorage.setItem('geminiApiKey', geminiApiKeyInput.value.trim());
                    GEMINI_API_KEY = geminiApiKeyInput.value.trim();
                    geminiKeyDisplay.textContent = `ç¾åœ¨è¨­å®šã•ã‚Œã¦ã„ã‚‹APIã‚­ãƒ¼: ${maskApiKey(GEMINI_API_KEY)}`;
                }

                // ãƒ¢ãƒ‡ãƒ«é¸æŠã¯å¸¸ã«ä¿å­˜
                localStorage.setItem('geminiModel', geminiModelSelect.value);
                GEMINI_MODEL = geminiModelSelect.value;

                // APIã‚­ãƒ¼è¨­å®šçŠ¶æ…‹ã‚’ç¢ºèªã—ã¦é€šçŸ¥ã‚’è¡¨ç¤º/éè¡¨ç¤º
                if (!ELEVENLABS_API_KEY || !GEMINI_API_KEY) {
                    apiNotification.style.display = 'block';
                } else {
                    apiNotification.style.display = 'none';
                }

                alert('è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ');
                settingsPanel.style.display = 'none';
            });

            // ã‚¨ãƒ©ãƒ¼ã‚³ãƒ³ã‚½ãƒ¼ãƒ«é–¢é€£
            errorIcon.addEventListener('click', () => {
                errorConsole.style.display = errorConsole.style.display === 'flex' ? 'none' : 'flex';
            });

            closeErrorBtn.addEventListener('click', () => {
                errorConsole.style.display = 'none';
            });

            clearErrorsBtn.addEventListener('click', () => {
                errorMessages.innerHTML = '';
                errorCount = 0;
                errorIcon.textContent = 'ğŸ”';
                errorIcon.classList.remove('has-errors');
            });

            // ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°æ©Ÿèƒ½
            function logError(error) {
                const message = typeof error === 'string' ? error : error.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼';
                const stack = error.stack ? `<details><summary>è©³ç´°</summary><pre>${error.stack}</pre></details>` : '';
                
                const errorElement = document.createElement('div');
                errorElement.className = 'error-message';
                errorElement.innerHTML = `
                    <strong>${new Date().toLocaleTimeString()}</strong>: 
                    ${message}
                    ${stack}
                `;
                
                errorMessages.appendChild(errorElement);
                errorCount++;
                
                // ã‚¨ãƒ©ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³ã‚’æ›´æ–°
                errorIcon.textContent = errorCount.toString();
                errorIcon.classList.add('has-errors');
                
                // ã‚¨ãƒ©ãƒ¼ãŒã‚ã‚Œã°è‡ªå‹•çš„ã«è¡¨ç¤º
                if (errorCount === 1) {
                    errorConsole.style.display = 'flex';
                }
            }

            // ã‚ªãƒªã‚¸ãƒŠãƒ«ã®console.errorã‚’ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰
            const originalConsoleError = console.error;
            console.error = function() {
                // ã‚ªãƒªã‚¸ãƒŠãƒ«ã®console.errorã‚’å®Ÿè¡Œ
                originalConsoleError.apply(console, arguments);
                
                // ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã«è¨˜éŒ²
                const args = Array.from(arguments);
                if (args.length > 0) {
                    logError(args[0]);
                }
            };

            // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒ©
            window.addEventListener('error', event => {
                logError(event.error || event.message);
            });

            // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã‚¤ãƒ™ãƒ³ãƒˆã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, preventDefaults, false);
            });

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            ['dragenter', 'dragover'].forEach(eventName => {
                dropArea.addEventListener(eventName, () => {
                    dropArea.classList.add('active');
                });
            });

            ['dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, () => {
                    dropArea.classList.remove('active');
                });
            });

            // ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‰ãƒ­ãƒƒãƒ—æ™‚ã®å‡¦ç†
            dropArea.addEventListener('drop', handleDrop);
            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                
                if (files.length) {
                    handleFiles(files[0]);
                }
            }

            // ãƒ‰ãƒ­ãƒƒãƒ—ã‚¨ãƒªã‚¢ã®ã‚¯ãƒªãƒƒã‚¯ã§ã‚‚ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
            dropArea.addEventListener('click', () => {
                fileInput.click();
            });

            // é€šå¸¸ã®ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠæ™‚ã®å‡¦ç†
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length) {
                    handleFiles(e.target.files[0]);
                }
            });

            // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã®å‡¦ç†
            function handleFiles(file) {
                selectedFile = file;
                
                // éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã©ã†ã‹ãƒã‚§ãƒƒã‚¯
                if (!file.type.startsWith('audio/')) {
                    alert('éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
                    selectedFile = null;
                    return;
                }

                // APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
                if (!ELEVENLABS_API_KEY || !GEMINI_API_KEY) {
                    alert('APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚è¨­å®šãƒ‘ãƒãƒ«ã§APIã‚­ãƒ¼ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚');
                    settingsPanel.style.display = 'flex';
                    return;
                }

                // ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªãƒ•ã‚¡ã‚¤ãƒ«ã®é•·ã•ã‚’å–å¾—
                getAudioDuration(file).then(duration => {
                    audioFileDuration = duration;
                    // ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±ã®è¡¨ç¤º
                    fileInfo.style.display = 'block';
                    fileInfo.textContent = `ãƒ•ã‚¡ã‚¤ãƒ«å: ${file.name} | ã‚µã‚¤ã‚º: ${formatFileSize(file.size)} | å½¢å¼: ${file.type} | é•·ã•: ${formatTime(duration)}`;
                    
                    // æ–‡å­—èµ·ã“ã—ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
                    transcribeBtn.disabled = false;
                    transcribeBtn.textContent = 'æ–‡å­—èµ·ã“ã—é–‹å§‹';
                    // æ–°ã—ã„ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚ŒãŸã®ã§ã€å‰ã®çµæœã‚’ã‚¯ãƒªã‚¢
                    resultSection.style.display = 'none';
                    rawTranscriptionText = '';
                }).catch(error => {
                    console.error('ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªé•·ã•å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                    // é•·ã•ãŒå–å¾—ã§ããªãã¦ã‚‚ç¶šè¡Œå¯èƒ½
                    fileInfo.style.display = 'block';
                    fileInfo.textContent = `ãƒ•ã‚¡ã‚¤ãƒ«å: ${file.name} | ã‚µã‚¤ã‚º: ${formatFileSize(file.size)} | å½¢å¼: ${file.type}`;
                    transcribeBtn.disabled = false;
                    transcribeBtn.textContent = 'æ–‡å­—èµ·ã“ã—é–‹å§‹';
                    resultSection.style.display = 'none';
                    rawTranscriptionText = '';
                });
            }

            // ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªãƒ•ã‚¡ã‚¤ãƒ«ã®é•·ã•ã‚’å–å¾—
            function getAudioDuration(file) {
                return new Promise((resolve, reject) => {
                    const audio = new Audio();
                    audio.addEventListener('loadedmetadata', () => {
                        // iOSã‚„Safariã§ã¯durationãŒç„¡é™å¤§ã«ãªã‚‹ã“ã¨ãŒã‚ã‚‹ã®ã§ã€å¯¾ç­–
                        if (isFinite(audio.duration)) {
                            resolve(audio.duration);
                        } else {
                            reject(new Error('éŸ³å£°ã®é•·ã•ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ'));
                        }
                    });
                    audio.addEventListener('error', () => {
                        reject(new Error('éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ'));
                    });
                    
                    // File ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‹ã‚‰URLã‚’ä½œæˆ
                    const url = URL.createObjectURL(file);
                    audio.src = url;
                });
            }

            // æ®‹ã‚Šæ™‚é–“è¡¨ç¤ºã®æ›´æ–°
            function updateTimeEstimate(startTime, estimatedTotalTime) {
                const updateTimer = setInterval(() => {
                    const elapsed = (Date.now() - startTime) / 1000; // çµŒéæ™‚é–“ï¼ˆç§’ï¼‰
                    const remaining = Math.max(0, estimatedTotalTime - elapsed);
                    
                    if (remaining <= 0 || !processingSection.style.display || processingSection.style.display === 'none') {
                        clearInterval(updateTimer);
                        timeInfo.textContent = '';
                        return;
                    }
                    
                    timeInfo.textContent = `æ¨å®šæ®‹ã‚Šæ™‚é–“: ${formatTime(remaining)}`;
                }, 1000);
                
                return updateTimer;
            }

            // ç§’ã‚’ã€Œâ—‹åˆ†â—‹ç§’ã€å½¢å¼ã«ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
            function formatTime(seconds) {
                seconds = Math.round(seconds);
                const minutes = Math.floor(seconds / 60);
                const remainingSeconds = seconds % 60;
                
                if (minutes > 0) {
                    return `${minutes}åˆ†${remainingSeconds}ç§’`;
                } else {
                    return `${remainingSeconds}ç§’`;
                }
            }

            // ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã®è¡¨ç¤ºå½¢å¼
            function formatFileSize(bytes) {
                if (bytes < 1024) return bytes + ' bytes';
                else if (bytes < 1048576) return (bytes / 1024).toFixed(2) + ' KB';
                else return (bytes / 1048576).toFixed(2) + ' MB';
            }

            // æ–‡å­—èµ·ã“ã—ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆ
            transcribeBtn.addEventListener('click', handleTranscription);
            
            // æ•´ç†ã‚’å†å®Ÿè¡Œã™ã‚‹ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆ
            reorganizeBtn.addEventListener('click', () => {
                if (rawTranscriptionText) {
                    // ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤ºã€ã‚¹ãƒ”ãƒŠãƒ¼ã‚’è¡¨ç¤º
                    reorganizeBtn.style.display = 'none';
                    reorganizeSpinner.style.display = 'inline-block';
                    organizeText(rawTranscriptionText);
                }
            });

            // æ–‡å­—èµ·ã“ã—å‡¦ç†
            async function handleTranscription() {
                if (!selectedFile) return;

                // APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
                if (!ELEVENLABS_API_KEY || !GEMINI_API_KEY) {
                    alert('APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚è¨­å®šãƒ‘ãƒãƒ«ã§APIã‚­ãƒ¼ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚');
                    settingsPanel.style.display = 'flex';
                    return;
                }

                // å‡¦ç†é–‹å§‹æ™‚é–“
                const startTime = Date.now();
                
                // å‡¦ç†ä¸­UIã®è¡¨ç¤º
                processingSection.style.display = 'block';
                transcribeBtn.disabled = true;
                progressBar.style.width = '0%';
                statusText.textContent = 'æ–‡å­—èµ·ã“ã—ã‚’é–‹å§‹ã—ã¦ã„ã¾ã™...';
                resultSection.style.display = 'none';

                try {
                    // éŸ³å£°ã®é•·ã•ã«åŸºã¥ã„ã¦ã€æ¨å®šå‡¦ç†æ™‚é–“ã‚’è¨ˆç®—
                    // å¹³å‡ã—ã¦ã€éŸ³å£°ã®é•·ã•ã®ç´„1.5å€ã®ç§’æ•°ãŒã‹ã‹ã‚‹ã¨ä»®å®š
                    const estimatedProcessingTime = audioFileDuration * 1.5;
                    
                    // æ®‹ã‚Šæ™‚é–“è¡¨ç¤ºã®åˆæœŸåŒ–
                    if (audioFileDuration > 0) {
                        timeInfo.textContent = `æ¨å®šæ®‹ã‚Šæ™‚é–“: ${formatTime(estimatedProcessingTime)}`;
                        // æ®‹ã‚Šæ™‚é–“ã®æ›´æ–°ã‚’é–‹å§‹
                        const timerUpdate = updateTimeEstimate(startTime, estimatedProcessingTime);
                    }

                    // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
                    let progress = 0;
                    const progressInterval = setInterval(() => {
                        // éŸ³å£°ã®é•·ã•ã«åŸºã¥ã„ã¦é€²è¡ŒçŠ¶æ³ã‚’èª¿æ•´
                        const elapsedTime = (Date.now() - startTime) / 1000;
                        if (audioFileDuration > 0) {
                            // çµŒéæ™‚é–“ã¨æ¨å®šå‡¦ç†æ™‚é–“ã«åŸºã¥ã„ã¦é€²è¡ŒçŠ¶æ³ã‚’è¨ˆç®—
                            progress = (elapsedTime / estimatedProcessingTime) * 100;
                        } else {
                            // éŸ³å£°ã®é•·ã•ãŒä¸æ˜ãªå ´åˆã¯ã€æ—¢å­˜ã®ãƒ©ãƒ³ãƒ€ãƒ é€²è¡Œã§
                            progress += Math.random() * 3;
                        }
                        
                        if (progress > 90) progress = 90; // 90%ã§æ­¢ã‚ã¦ãŠã
                        progressBar.style.width = `${progress}%`;
                        
                        // é€²è¡ŒçŠ¶æ³ã«ã‚ˆã£ã¦ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ†ã‚­ã‚¹ãƒˆã‚’å¤‰æ›´
                        if (progress < 30) {
                            statusText.textContent = 'éŸ³å£°ãƒ‡ãƒ¼ã‚¿ã‚’å‡¦ç†ä¸­...';
                        } else if (progress < 60) {
                            statusText.textContent = 'æ–‡å­—èµ·ã“ã—ä¸­...';
                        } else {
                            statusText.textContent = 'æ–‡å­—èµ·ã“ã—ãƒ‡ãƒ¼ã‚¿ã‚’æ•´ç†ä¸­...';
                        }
                    }, 800);

                    // FormDataã®ä½œæˆ
                    const formData = new FormData();
                    formData.append('file', selectedFile);
                    formData.append('model_id', 'scribe_v1');  // ãƒ¢ãƒ‡ãƒ«IDæŒ‡å®š
                    formData.append('language_code', 'ja');    // è¨€èªã‚³ãƒ¼ãƒ‰æ˜ç¤ºçš„ã«æŒ‡å®š
                    formData.append('diarize', 'true');        // è©±è€…è­˜åˆ¥ã‚’æœ‰åŠ¹ã«

                    // ElevenLabs API å‘¼ã³å‡ºã—
                    const response = await fetch('https://api.elevenlabs.io/v1/speech-to-text', {
                        method: 'POST',
                        headers: {
                            'xi-api-key': ELEVENLABS_API_KEY
                        },
                        body: formData
                    });

                    if (!response.ok) {
                        throw new Error('æ–‡å­—èµ·ã“ã—å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ (ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰: ' + response.status + ')');
                    }

                    // ElevenLabsã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è§£æ
                    const result = await response.json();
                    transcriptionResult = result;
                    console.log("ElevenLabs APIãƒ¬ã‚¹ãƒãƒ³ã‚¹:", result);

                    // æ–‡å­—èµ·ã“ã—ãƒ†ã‚­ã‚¹ãƒˆã®æŠ½å‡º
                    let transcriptionText = '';
                    
                    // ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ§‹é€ ã«å¿œã˜ãŸå‡¦ç†
                    if (result.utterances && result.utterances.length > 0) {
                        // utterancesãŒã‚ã‚Œã°ã€ãã‚Œã‚’ä½¿ç”¨ï¼ˆè©±è€…è­˜åˆ¥æƒ…å ±ã‚’å«ã‚€ï¼‰
                        result.utterances.forEach((utterance, index) => {
                            // è©±è€…IDã‚’æ•°å­—ã‹ã‚‰ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆã«å¤‰æ›ï¼ˆæ•°å€¤ãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿ï¼‰
                            const speakerId = utterance.speaker !== undefined && utterance.speaker !== null ? 
                                numberToAlphabet(utterance.speaker) : 'X';
                            
                            // è©±è€…ã‚¿ã‚°ã‚’HTMLã§ã‚¹ã‚¿ã‚¤ãƒªãƒ³ã‚°
                            transcriptionText += `<span class="speaker-tag">è©±è€…${speakerId}</span>${utterance.text}\n\n`;
                        });
                    } else if (result.words && result.words.length > 0) {
                        // wordsãŒã‚ã‚Œã°ã€wordsã‹ã‚‰è©±è€…æƒ…å ±ã‚’ä½¿ç”¨
                        let currentSpeaker = null;
                        let currentText = '';
                        
                        result.words.forEach((word, idx) => {
                            // speaker_idãŒæœªå®šç¾©ã¾ãŸã¯æ–‡å­—åˆ—ã®Xã®å ´åˆã¯1ã¨ã—ã¦ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆAã«å¤‰æ›
                            const speakerId = word.speaker_id !== undefined && word.speaker_id !== null && 
                                            word.speaker_id !== 'X' ? word.speaker_id : 1;
                            
                            if (currentSpeaker === null) {
                                currentSpeaker = speakerId;
                                currentText = word.text;
                            } else if (speakerId !== currentSpeaker) {
                                // è©±è€…ãŒå¤‰ã‚ã£ãŸã‚‰å‡ºåŠ›
                                const speakerTag = numberToAlphabet(currentSpeaker);
                                transcriptionText += `<span class="speaker-tag">è©±è€…${speakerTag}</span>${currentText}\n\n`;
                                currentSpeaker = speakerId;
                                currentText = word.text;
                            } else {
                                currentText += word.text;
                            }
                        });
                        
                        // æœ€å¾Œã®è©±è€…ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’å‡ºåŠ›
                        if (currentText) {
                            const speakerTag = numberToAlphabet(currentSpeaker);
                            transcriptionText += `<span class="speaker-tag">è©±è€…${speakerTag}</span>${currentText}\n\n`;
                        }
                    } else if (result.text) {
                        // å˜ç´”ãªãƒ†ã‚­ã‚¹ãƒˆã®å ´åˆï¼ˆè©±è€…è­˜åˆ¥ãªã—ï¼‰
                        transcriptionText = `<span class="speaker-tag">è©±è€…A</span>${result.text}`;
                    } else if (result.transcription) {
                        // ä»¥å‰ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç”¨
                        transcriptionText = formatTranscriptionWithSpeakers(result.transcription);
                    } else {
                        throw new Error('æ–‡å­—èµ·ã“ã—ãƒ‡ãƒ¼ã‚¿ãŒé©åˆ‡ãªå½¢å¼ã§ã¯ã‚ã‚Šã¾ã›ã‚“');
                    }
                    
                    // ç”Ÿã®ãƒ†ã‚­ã‚¹ãƒˆï¼ˆHTMLã‚¿ã‚°ãªã—ï¼‰ã‚’ä¿å­˜
                    rawTranscriptionText = transcriptionText.replace(/<[^>]+>/g, '');
                    
                    // ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã«è¡¨ç¤ºï¼ˆHTMLï¼‰
                    rawTranscription.innerHTML = transcriptionText;
                    
                    // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã‚’100%ã«ã™ã‚‹
                    clearInterval(progressInterval);
                    progressBar.style.width = '100%';
                    statusText.textContent = 'æ–‡å­—èµ·ã“ã—å®Œäº†ï¼ãƒ†ã‚­ã‚¹ãƒˆã‚’æ•´ç†ã—ã¦ã„ã¾ã™...';

                    // Gemini APIã§ãƒ†ã‚­ã‚¹ãƒˆã‚’æ•´ç†
                    await organizeText(rawTranscriptionText);

                    // çµæœè¡¨ç¤º
                    resultSection.style.display = 'block';
                    processingSection.style.display = 'none';
                    
                    // æ–‡å­—èµ·ã“ã—ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºã‚’æ›´æ–°
                    transcribeBtn.disabled = false;
                    transcribeBtn.textContent = 'æ–°è¦æ–‡å­—èµ·ã“ã—';
                    
                } catch (error) {
                    console.error('ã‚¨ãƒ©ãƒ¼:', error);
                    alert(`ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`);
                    processingSection.style.display = 'none';
                    transcribeBtn.disabled = false;
                }
            }

            // æ•°å­—ã‚’ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆã«å¤‰æ›ï¼ˆ1â†’A, 2â†’B, ...ï¼‰
            function numberToAlphabet(num) {
                if (num === undefined || num === null) {
                    return 'A'; // æœªå®šç¾©ã®å ´åˆã¯Aã‚’è¿”ã™
                }
                
                if (typeof num === 'string') {
                    // æ•°å­—æ–‡å­—åˆ—ã§ãªã„å ´åˆï¼ˆä¾‹: 'X'ï¼‰ã¯ã€Aã‚’è¿”ã™
                    if (isNaN(parseInt(num, 10))) return 'A';
                    // æ•°å­—æ–‡å­—åˆ—ã®å ´åˆã¯æ•°å€¤ã«å¤‰æ›
                    num = parseInt(num, 10);
                }
                
                // 0ã¾ãŸã¯æœªè¨­å®šã®å ´åˆã¯1ã¨ã¿ãªã™
                if (!num) num = 1;
                
                // 1-26ã®ç¯„å›²ã§A-Zã«å¤‰æ›
                if (num >= 1 && num <= 26) {
                    return String.fromCharCode(64 + num); // 65ãŒAã®ã‚³ãƒ¼ãƒ‰ã€64+1=65
                } else {
                    return num.toString(); // ç¯„å›²å¤–ãªã‚‰ãã®ã¾ã¾æ•°å­—ã§è¿”ã™
                }
            }

            // Gemini APIã§ãƒ†ã‚­ã‚¹ãƒˆã‚’æ•´ç†
            async function organizeText(text) {
                try {
                    statusText.textContent = 'ãƒ†ã‚­ã‚¹ãƒˆã‚’æ•´ç†ä¸­...';
                    processingSection.style.display = 'block';
                    progressBar.style.width = '30%';
                    
                    // æ®‹ã‚Šæ™‚é–“è¡¨ç¤ºã‚’åˆæœŸåŒ–
                    const startTime = Date.now();
                    const estimatedProcessingTime = 20; // ç´„20ç§’ã¨ä»®å®š
                    timeInfo.textContent = `æ¨å®šæ®‹ã‚Šæ™‚é–“: ${formatTime(estimatedProcessingTime)}`;
                    const timerUpdate = updateTimeEstimate(startTime, estimatedProcessingTime);
                    
                    // Gemini APIã«é€ä¿¡ã™ã‚‹ãƒ‡ãƒ¼ã‚¿
                    const promptText = `
ä»¥ä¸‹ã¯éŸ³å£°ã®æ–‡å­—èµ·ã“ã—ãƒ‡ãƒ¼ã‚¿ã§ã™ã€‚æ—¥æœ¬èªã§å¿œç­”ã—ã¦ãã ã•ã„ï¼š

${text}

${promptInput.value}
`;
                    
                    // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã‚’æ›´æ–°
                    progressBar.style.width = '50%';
                    
                    // ã©ã®Geminiãƒ¢ãƒ‡ãƒ«ã‚’ä½¿ã†ã‹ç¢ºèª
                    const modelName = GEMINI_MODEL;
                    
                    // ãƒ¢ãƒ‡ãƒ«åã‚’ãƒ™ãƒ¼ã‚¹ã«ã—ãŸã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
                    let apiEndpoint;
                    if (modelName === 'gemini-1.5-flash' || modelName === 'gemini-1.5-pro' || modelName === 'gemini-1.0-pro') {
                        // æ—§ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ãƒ¢ãƒ‡ãƒ«ã¯v1beta
                        apiEndpoint = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent`;
                    } else {
                        // æ–°ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¯v1
                        apiEndpoint = `https://generativelanguage.googleapis.com/v1/models/${modelName}:generateContent`;
                    }
                    
                    // Gemini APIãƒªã‚¯ã‚¨ã‚¹ãƒˆ
                    const requestData = {
                        contents: [
                            {
                                parts: [
                                    { text: promptText }
                                ]
                            }
                        ],
                        generationConfig: {
                            temperature: 0.2,
                            topK: 40,
                            topP: 0.95,
                            maxOutputTokens: 8192,
                        }
                    };

                    // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã‚’æ›´æ–°
                    progressBar.style.width = '70%';

                    // Gemini APIã‚’å‘¼ã³å‡ºã—
                    const response = await fetch(
                        `${apiEndpoint}?key=${GEMINI_API_KEY}`,
                        {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(requestData)
                        }
                    );

                    if (!response.ok) {
                        throw new Error('ãƒ†ã‚­ã‚¹ãƒˆæ•´ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ (ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰: ' + response.status + ')');
                    }

                    const result = await response.json();
                    console.log("Gemini APIãƒ¬ã‚¹ãƒãƒ³ã‚¹:", result);
                    
                    // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã‚’æ›´æ–°
                    progressBar.style.width = '100%';
                    
                    // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‹ã‚‰ãƒ†ã‚­ã‚¹ãƒˆéƒ¨åˆ†ã‚’æŠ½å‡º (æœ€æ–°ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹å½¢å¼ã«å¯¾å¿œ)
                    if (result && 
                        result.candidates && 
                        result.candidates[0] && 
                        result.candidates[0].content && 
                        result.candidates[0].content.parts && 
                        result.candidates[0].content.parts[0]) {
                        organizedText.textContent = result.candidates[0].content.parts[0].text;
                        
                        // æ•´ç†æ¸ˆã¿ã‚¿ãƒ–ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«ã™ã‚‹
                        tabButtons.forEach(btn => btn.classList.remove('active'));
                        tabPanes.forEach(pane => pane.classList.remove('active'));
                        document.querySelector('.tab-btn[data-target="organizedTab"]').classList.add('active');
                        document.getElementById('organizedTab').classList.add('active');
                    } else {
                        throw new Error('APIãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®å½¢å¼ãŒäºˆæœŸã—ãªã„ã‚‚ã®ã§ã—ãŸ');
                    }
                    
                    // å‡¦ç†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’éè¡¨ç¤º
                    processingSection.style.display = 'none';
                    
                    // å†å®Ÿè¡Œãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™
                    reorganizeBtn.style.display = 'block';
                    reorganizeSpinner.style.display = 'none';
                    
                } catch (error) {
                    console.error('ãƒ†ã‚­ã‚¹ãƒˆæ•´ç†ã‚¨ãƒ©ãƒ¼:', error);
                    organizedText.textContent = `ãƒ†ã‚­ã‚¹ãƒˆæ•´ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}\n\nå…ƒã®ãƒ†ã‚­ã‚¹ãƒˆã‚’ãã®ã¾ã¾ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚`;
                    processingSection.style.display = 'none';
                    reorganizeBtn.style.display = 'block';
                    reorganizeSpinner.style.display = 'none';
                }
            }

            // è©±è€…è­˜åˆ¥ãŒã‚ã‚‹å ´åˆã®ãƒ†ã‚­ã‚¹ãƒˆæ•´å½¢ï¼ˆæ—§ãƒãƒ¼ã‚¸ãƒ§ãƒ³äº’æ›ç”¨ï¼‰
            function formatTranscriptionWithSpeakers(transcription) {
                if (Array.isArray(transcription)) {
                    // è©±è€…ã”ã¨ã®ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚’æ•´å½¢ã—ã¦çµåˆ
                    let formattedText = '';
                    transcription.forEach(segment => {
                        // è©±è€…IDã‚’æ•°å­—ã‹ã‚‰ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆã«å¤‰æ›
                        const speakerId = segment.speaker !== undefined && segment.speaker !== null ? 
                            numberToAlphabet(segment.speaker) : 'A';
                        formattedText += `<span class="speaker-tag">è©±è€…${speakerId}</span>${segment.text}\n\n`;
                    });
                    return formattedText;
                }
                return `<span class="speaker-tag">è©±è€…A</span>${transcription.toString()}`;
            }

            // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆæ©Ÿèƒ½
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚¯ãƒ©ã‚¹ã‚’å…¨ã¦å‰Šé™¤
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    tabPanes.forEach(pane => pane.classList.remove('active'));
                    
                    // ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸãƒœã‚¿ãƒ³ã¨ãã‚Œã«å¯¾å¿œã™ã‚‹ãƒšã‚¤ãƒ³ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«
                    button.classList.add('active');
                    const targetId = button.getAttribute('data-target');
                    document.getElementById(targetId).classList.add('active');
                });
            });

            // ã‚³ãƒ”ãƒ¼ãƒœã‚¿ãƒ³æ©Ÿèƒ½
            copyRawBtn.addEventListener('click', () => {
                // HTMLã‚¿ã‚°ã‚’é™¤å»ã—ã¦ãƒ—ãƒ¬ãƒ¼ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã¨ã—ã¦ã‚³ãƒ”ãƒ¼
                const plainText = rawTranscription.textContent;
                copyToClipboard(plainText);
                showCopyFeedback(copyRawBtn);
            });

            copyOrganizedBtn.addEventListener('click', () => {
                copyToClipboard(organizedText.textContent);
                showCopyFeedback(copyOrganizedBtn);
            });

            function copyToClipboard(text) {
                navigator.clipboard.writeText(text)
                    .catch(err => {
                        console.error('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ:', err);
                        alert('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err);
                    });
            }

            function showCopyFeedback(button) {
                const originalText = button.textContent;
                button.textContent = 'ã‚³ãƒ”ãƒ¼æ¸ˆã¿ï¼';
                setTimeout(() => {
                    button.textContent = originalText;
                }, 2000);
            }

            // ä¿å­˜ãƒœã‚¿ãƒ³æ©Ÿèƒ½
            saveRawBtn.addEventListener('click', () => {
                // HTMLã‚¿ã‚°ã‚’é™¤å»ã—ã¦ãƒ—ãƒ¬ãƒ¼ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã¨ã—ã¦ä¿å­˜
                const plainText = rawTranscription.textContent;
                saveTextToFile(plainText, 'æ–‡å­—èµ·ã“ã—çµæœ.txt');
            });

            saveOrganizedBtn.addEventListener('click', () => {
                saveTextToFile(organizedText.textContent, 'æ•´ç†æ¸ˆã¿æ–‡å­—èµ·ã“ã—.txt');
            });

            function saveTextToFile(text, filename) {
                const blob = new Blob([text], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                a.click();
                URL.revokeObjectURL(url);
            }

            // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå…¥åŠ›å¾Œã«Gemini APIã§å†æ•´ç†
            let debounceTimer;
            promptInput.addEventListener('change', () => {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(() => {
                    if (rawTranscriptionText) {
                        reorganizeBtn.style.display = 'none';
                        reorganizeSpinner.style.display = 'inline-block';
                        organizeText(rawTranscriptionText);
                    }
                }, 500);
            });
        });
    </script>
</body>
</html>